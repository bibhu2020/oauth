trigger: none

resources:
  pipelines:
    - pipeline: oauthapi-build-pipeline  # Reference the correct pipeline
      source: \oauth\oauthapi-build-pipeline  # Ensure the source is correct
      project: 'kube9t.com'
      trigger: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  webAppName: 'oauthv2api'
  resourceGroupName: 'oauth-rg'
  artifactName: 'oauthapi'   # Match the artifact name from the build pipeline
  artifactPath: '$(Pipeline.Workspace)/$(artifactName)/$(artifactName).zip'  # Correct artifact path

stages:
- stage: Deploy
  jobs:
  - job: DeployToAzure
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'specific'
        project: 'kube9t.com'
        pipeline: 'oauthapi-build-pipeline'   # Correct pipeline reference
        runVersion: 'latest'   # Always download the latest successful run
        artifact: '$(artifactName)'   # The artifact name published in the build pipeline
        targetPath: '$(Pipeline.Workspace)/$(artifactName)'   # The location where the artifact will be downloaded
      displayName: 'Download build artifact'

    - task: AzureAppServiceSettings@1
      inputs:
        azureSubscription: 'azuredevops-fic'   # Replace with your Azure connection name
        appName: '$(webAppName)'   # Azure Web App name
        appSettings: |
          [
            {"name": "PORT", "value": "$(OAUTHAPI_PORT)"},
            {"name": "NODE_ENV", "value": "$(OAUTHAPI_ENVIRONMENT)"},
            {"name": "API_KEY", "value": "$(OAUTHAPI_OAUTHAPI_KEY)"},
            {"name": "GEN_API_URI", "value": "$(OAUTHAPI_GENAI_URI)"},
            {"name": "MANAGED_IDENTITY_CLIENT_ID", "value": "$(OAUTHAPI_MANAGED_IDENTITY_CLIENT_ID)"},
            {"name": "AZURE_TENANT_ID", "value": "$(OAUTHAPI_AZURE_TENANT_ID)"},
            {"name": "AZURE_CLIENT_ID", "value": "$(OAUTHAPI_AZURE_CLIENT_ID)"},
            {"name": "AZURE_CLIENT_SECRET", "value": "$(OAUTHAPI_AZURE_CLIENT_SECRET)"},
            {"name": "WEATHER_SERVICE_API_KEY", "value": "$(OAUTHAPI_WEATHER_SERVICE_API_KEY)"},
            {"name": "APPINSIGHTS_CONNECTION_STRING", "value": "$(OAUTHAPI_APPINSIGHTS_CONNECTION_STRING)"},
            {"name": "USE_CACHE", "value": "$(OAUTHAPI_USE_CACHE)"}
          ]
      displayName: 'Add environment variables to web app'

    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'azuredevops-fic'   # Replace with your Azure connection name
        appName: '$(webAppName)'   # Azure Web App name
        package: '$(artifactPath)'   # Path to the downloaded artifact
        appType: 'webApp'   # Specify that we are deploying a web app
      displayName: 'Deploy web app to Azure'

    - script: |
        # Test site health using curl
        http_code=$(curl -s -o /dev/null -w "%{http_code}" "https://oauthapp.azurewebsites.net/azure/readKv?name=oauthappkv&accessMethod=FIC")
        if [ "$http_code" -ne 200 ]; then
          echo "Site is not healthy (HTTP code: $http_code)"
          exit 1
        else
          echo "Site is healthy (HTTP code: $http_code)" 
        fi
      displayName: 'Check website health'
